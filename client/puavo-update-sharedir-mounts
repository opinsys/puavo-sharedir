#!/bin/sh

set -eu

# 10000 is the minimum uid for Puavo users, do nothing for users below that
[ "$(id -u "$PAM_USER")" -lt 10000 ] && exit 0

# if "use_sharedir_mounts"-tags is not set, do nothing
if ! jq -r .tags[] /etc/puavo/device.json | grep -qx use_sharedir_mounts; then
  exit 0
fi

AUTOFS_MAPFILE=/var/lib/puavo-sharedir-client/auto.cifs

puavo_domain=$(cat /etc/puavo/domain)

userdir="/home/${PAM_USER}/.puavo-sharedir.userdir"
userunc="://homedir.${puavo_domain}/${PAM_USER}"

schooldir="/home/${PAM_USER}/.puavo-sharedir.schooldir"
schoolunc="://homedir.${puavo_domain}/share"

uid=$(id -u "${PAM_USER}")
gid=$(id -g "${PAM_USER}")

mountopts="-fstype=cifs,rw,cruid=${PAM_USER},user=${PAM_USER},uid=${uid},forceuid,gid=${gid},forcegid,sec=krb5,nobrl"

mkdir -p /var/lib/puavo-sharedir-client

echo "${userdir} ${mountopts} ${userunc}" >"${AUTOFS_MAPFILE}"
echo "${schooldir} ${mountopts} ${schoolunc}" >>"${AUTOFS_MAPFILE}"
restart autofs
