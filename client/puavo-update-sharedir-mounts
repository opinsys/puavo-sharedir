#!/bin/sh

set -eu

AUTOFS_MAPFILE=/var/lib/puavo-sharedir-client/auto.cifs

puavo_domain=$(cat /etc/puavo/domain)

userdir="/home/${PAM_USER}/.puavo-sharedir.userdir"
userunc="://homedir.${puavo_domain}/${PAM_USER}"

schooldir="/home/${PAM_USER}/.puavo-sharedir.schooldir"
schoolunc="://homedir.${puavo_domain}/share"

uid=$(id -u "${PAM_USER}")
gid=$(id -g "${PAM_USER}")

mountopts="-fstype=cifs,rw,cruid=${PAM_USER},user=${PAM_USER},uid=${uid},forceuid,gid=${gid},forcegid,sec=krb5"

mkdir -p /var/lib/puavo-sharedir-client

echo "${userdir} ${mountopts} ${userunc}" >"${AUTOFS_MAPFILE}"
echo "${schooldir} ${mountopts} ${schoolunc}" >>"${AUTOFS_MAPFILE}"
restart autofs
