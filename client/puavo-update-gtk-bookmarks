#!/bin/sh

set -eux

SAMBAHOMES=$(jq -r '.tags[] | select(. == "sambahomes")' /etc/puavo/device.json)

update_bookmarks() {
    local bookmarksdir
    local bookmarksfile
    local schooldir_displayname
    local sharename
    local tmpfile
    local userdir_displayname

    userdir_displayname=$1
    schooldir_displayname=$2
    sharename=$3
    bookmarksfile=$4

    bookmarksdir=$(dirname "${bookmarksfile}")
    mkdir -p "${bookmarksdir}"
    touch "${bookmarksfile}"

    tmpfile="${bookmarksfile}.tmp"

    # Grep fails if the file is empty, which is ok in this situation: it
    # just means that there is not anything to preserve.
    egrep -v "\.puavo-sharedir|^file:///home/share/|^smb://homedir\.$(cat /etc/puavo/domain)/" "${bookmarksfile}" >"${tmpfile}" || true

    case "$(cat /etc/puavo/hosttype)" in
        laptop)
            echo "file://${HOME}/.puavo-sharedir.userdir ${userdir_displayname}" >>"${tmpfile}"
            echo "file://${HOME}/.puavo-sharedir.schooldir/${sharename}/$(id -gn) ${schooldir_displayname}" >>"${tmpfile}"
            ;;
        *)
            if [ -n "$SAMBAHOMES" ]; then
                echo "file://${HOME}/.puavo-sharedir.schooldir/${sharename}/$(id -gn) ${schooldir_displayname}" >>"${tmpfile}"
            else
                echo "file:///home/share/${sharename}/$(id -gn) ${schooldir_displayname}" >>"${tmpfile}"
            fi
            ;;
    esac

    mv "${tmpfile}" "${bookmarksfile}"
}

case "$(echo $LANG | cut -c 1-2)" in
  fi)
    userdir_displayname='Verkkokansio'
    schooldir_displayname='Yhteiset'
    sharename='yhteiset'
    ;;
  sv)
    userdir_displayname='NÃ¤tverksmapp'
    schooldir_displayname='Delade Filer'
    sharename='delade_filer'
    ;;
  *)
    userdir_displayname='Network folder'
    schooldir_displayname='Share'
    sharename='share'
    ;;
esac

update_bookmarks "${userdir_displayname}" "${schooldir_displayname}" "${sharename}" "${HOME}/.gtk-bookmarks"
update_bookmarks "${userdir_displayname}" "${schooldir_displayname}" "${sharename}" "${HOME}/.config/gtk-3.0/bookmarks"
