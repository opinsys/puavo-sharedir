#!/bin/sh

set -eu

puavo_domain=$(cat /etc/puavo/domain)
puavo_hosttype=$(cat /etc/puavo/hosttype)

use_sambahomes() {
  jq -r '.tags[]' /etc/puavo/device.json | grep -qx sambahomes
}

filter_out_our_bookmarks() {
    local domain_re_pattern
    domain_re_pattern=$(echo "^smb://homedir.${puavo_domain}" \
                          | sed 's/\./\\./g')

    # Grep fails if the file is empty or missing, which is ok in this
    # situation: it just means that there is not anything to preserve
    # (or maybe means something else, but probably not serious).
    egrep -v "\.puavo-sharedir|^file:///home/share/|${domain_re_pattern}" \
      || true
}

update_bookmarks() {
    local bookmarksdir
    local bookmarksfile
    local schooldir_displayname
    local sharename
    local tmpfile

    schooldir_displayname=$1
    sharename=$2
    bookmarksfile=$3

    bookmarksdir=$(dirname "${bookmarksfile}")
    mkdir -p "${bookmarksdir}"

    tmpfile="${bookmarksfile}.tmp"

    filter_out_our_bookmarks < "${bookmarksfile}" > "${tmpfile}"

    case "$puavo_hosttype" in
        fatclient|ltspserver)
            if use_sambahomes; then
                echo "file://${HOME}/.puavo-sharedir.schooldir/${sharename}/$(id -gn) ${schooldir_displayname}" >> "${tmpfile}"
            else
                user_primary_group=$(id -gn)
                echo "file:///home/share/${sharename}/${user_primary_group} ${schooldir_displayname}" >> "${tmpfile}"
            fi
            ;;
        laptop)
            # do nothing... we end up cleaning up old stuff from
            # ${bookmarksfile}
            ;;
    esac

    mv "${tmpfile}" "${bookmarksfile}"
}

case "$(echo $LANG | cut -c 1-2)" in
  fi)
    schooldir_displayname='Yhteiset'
    sharename='yhteiset'
    ;;
  sv)
    schooldir_displayname='Delade Filer'
    sharename='delade_filer'
    ;;
  *)
    schooldir_displayname='Share'
    sharename='share'
    ;;
esac

for bookmark_file in "${HOME}/.config/gtk-3.0/bookmarks" \
                     "${HOME}/.gtk-bookmarks"; do
  update_bookmarks "$schooldir_displayname" "$sharename" "$bookmark_file"
done
