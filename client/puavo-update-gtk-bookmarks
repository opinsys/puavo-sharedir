#!/bin/sh

set -eu

puavo_domain=$(cat /etc/puavo/domain)
puavo_hosttype=$(cat /etc/puavo/hosttype)

user_primary_group=$(id -gn)

has_device_tag() {
  jq -r .tags[] /etc/puavo/device.json | grep -qx "$1"
}

use_remotemounts() {
  # Doing the remote mounts is the default,
  # "no_use_remotemounts"-tag will disable that,
  # but then again "use_remotemounts"-tag overrides it.
  ! has_device_tag no_use_remotemounts || has_device_tag use_remotemounts
}

use_sambahomes() { has_device_tag sambahomes; }

filter_out_our_bookmarks() {
  local domain_re_pattern
  domain_re_pattern=$(echo "^smb://homedir.${puavo_domain}" \
			| sed 's/\./\\./g')

  # Grep fails if the file is empty or missing, which is ok in this
  # situation: it just means that there is not anything to preserve
  # (or maybe means something else, but probably not serious).
  egrep -v "\.puavo-sharedir|^file:///home/share/|${domain_re_pattern}" \
    || true
}

update_bookmarks() {
  local bookmarksdir
  local bookmarksfile
  local schooldir_displayname
  local sharename
  local tmpfile

  schooldir_displayname=$1
  sharename=$2
  bookmarksfile=$3

  bookmarksdir=$(dirname "${bookmarksfile}")
  mkdir -p "${bookmarksdir}"

  tmpfile="${bookmarksfile}.tmp"

  filter_out_our_bookmarks < "${bookmarksfile}" > "${tmpfile}"

  case "$puavo_hosttype" in
    fatclient|ltspserver)
      if use_sambahomes; then
	echo "file://${HOME}/.puavo-sharedir.schooldir/${sharename}/${user_primary_group} ${schooldir_displayname}" >> "${tmpfile}"
      else
	echo "file:///home/share/${sharename}/${user_primary_group} ${schooldir_displayname}" >> "${tmpfile}"
      fi
      ;;
    laptop)
      # do nothing... we end up cleaning up old stuff from
      # ${bookmarksfile}
      ;;
  esac

  mv "${tmpfile}" "${bookmarksfile}"
}

case "$(echo $LANG | cut -c 1-2)" in
  fi)
    userdir_displayname='Verkkokansio'
    schooldir_displayname='Yhteiset'
    sharename='yhteiset'
    ;;
  sv)
    userdir_displayname='NÃ¤tverksmapp'
    schooldir_displayname='Delade Filer'
    sharename='delade_filer'
    ;;
  *)
    userdir_displayname='Network folder'
    schooldir_displayname='Share'
    sharename='share'
    ;;
esac

for bookmark_file in ~/.config/gtk-3.0/bookmarks ~/.gtk-bookmarks; do
  update_bookmarks "$schooldir_displayname" "$sharename" "$bookmark_file"
done


# handle links from user home directory to gvfs-mounts for applications
# that do not understand gvfs
case "$puavo_hosttype" in
  fatclient|ltspserver)
    if use_sambahomes; then
      ln -fns ~/.puavo-sharedir.schooldir ~/"${schooldir_displayname}"
    else
      rmdir ~/.puavo-sharedir.schooldir 2>/dev/null || true
      ln -fns "/home/share/${sharename}/${user_primary_group}" \
              ~/"${schooldir_displayname}"
    fi
    ;;
  laptop)
    rmdir ~/.puavo-sharedir.schooldir \
          ~/.puavo-sharedir.userdir 2>/dev/null || true

    if use_remotemounts; then
      user_id=$(id -u)
      ln -fns "/run/user/${user_id}/gvfs/smb-share:server=homedir.${puavo_domain},share=${USER}" \
	      ~/"${userdir_displayname}"
      ln -fns "/run/user/${user_id}/gvfs/smb-share:server=homedir.${puavo_domain},share=share/${sharename}/${user_primary_group}" \
	      ~/"${schooldir_displayname}"
    else
      rm -f ~/"${schooldir_displayname}" ~/"${userdir_displayname}"
    fi
    ;;
esac
