#!/bin/sh

set -eu

has_device_tag() {
  jq -r .device.tags[] "$PUAVO_SESSION_PATH" | grep -qx "$1"
}

# doing the mounts + bookmarks is the default,
# "no_sharedir_mounts"-tag will disable,
# but "use_sharedir_mounts"-tag overrides it
if has_device_tag no_sharedir_mounts \
     && ! has_device_tag use_sharedir_mounts; then
  exit 0
fi

puavo_domain=$(cat /etc/puavo/domain)
puavo_hosttype=$(cat /etc/puavo/hosttype)

case "$(echo $LANG | cut -c 1-2)" in
  fi) sharename='yhteiset'     ;;
  sv) sharename='delade_filer' ;;
  *)  sharename='share'        ;;
esac

gvfs_mounts=""

case "$puavo_hosttype" in
  fatclient|ltspserver)
    ;;
  laptop)
    gvfs_mounts="
      smb://homedir.${puavo_domain}/${USER}
      smb://homedir.${puavo_domain}/share/${sharename}
    "
    ;;
  *)
    exit 0
    ;;
esac

#
# XXX should setup bookmark files here
#

#
# ensure mounts to remote directories come up and stay
#

for mnt in $gvfs_mounts; do
  {
    while true; do
      gvfs-mount $mnt || true
      sleep 10
    done
  } &
done

wait
